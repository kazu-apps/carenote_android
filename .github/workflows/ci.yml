name: CI

on:
  pull_request:
    branches: [master]
  push:
    branches: [master]
  workflow_dispatch:
    inputs:
      update_snapshots:
        description: 'Update Roborazzi golden images'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  checks: write

jobs:
  build-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - uses: gradle/actions/setup-gradle@v4

      - name: Install Android SDK 36
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-36"

      - name: Grant gradlew permission
        run: chmod +x ./gradlew

      - name: Build
        run: ./gradlew :app:assembleDebug

      - name: Unit Tests + Coverage Verification
        run: ./gradlew :app:jacocoTestCoverageVerification

      - name: Screenshot Tests (verify)
        if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.update_snapshots == true) }}
        run: ./gradlew :app:verifyRoborazziDebug

      - name: Screenshot Tests (record)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.update_snapshots == true }}
        run: ./gradlew :app:recordRoborazziDebug

      - name: Commit updated snapshots
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.update_snapshots == true }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add app/src/test/snapshots/
          if git diff --cached --quiet; then
            echo "No snapshot changes to commit"
          else
            git commit -m "chore: update Roborazzi golden images [skip ci]"
            git push
          fi

      - name: Upload screenshot diffs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: roborazzi-diffs
          path: app/build/outputs/roborazzi/

      - name: Install Detekt
        run: |
          DETEKT_VERSION=1.23.7
          curl -sSL "https://github.com/detekt/detekt/releases/download/v${DETEKT_VERSION}/detekt-cli-${DETEKT_VERSION}.zip" -o detekt.zip
          unzip detekt.zip -d detekt-cli

      - name: Run Detekt
        continue-on-error: true
        run: ./detekt-cli/detekt-cli-*/bin/detekt-cli --config detekt.yml --input app/src/main/java

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            app/build/reports/tests/
            app/build/test-results/testDebugUnitTest/
            app/build/reports/jacoco/

      - name: Test Report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Unit Tests
          path: app/build/test-results/testDebugUnitTest/*.xml
          reporter: java-junit

  e2e-test:
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - uses: gradle/actions/setup-gradle@v4

      - name: Install Android SDK 36
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-36"

      - name: Grant gradlew permission
        run: chmod +x ./gradlew

      - name: Run E2E tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          arch: x86_64
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: true
          script: ./gradlew :app:connectedDebugAndroidTest

      - name: Upload E2E results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results
          path: app/build/reports/androidTests/connected/
